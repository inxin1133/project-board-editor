{% extends "layout_main.html" %}
{% block title %}게시글 읽기{% endblock %}
{% block content %}
<h2 class="mb-4">게시글 읽기</h2>
<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">{{ board.title }}</h5>
    <div class="mb-2">
      <span class="me-3">
        <i class="lucide lucide-thumbs-up" style="vertical-align:middle;"></i>
        <span class="fw-bold">{{ board.likes }}</span> 추천
      </span>
      <span>
        <i class="lucide lucide-eye" style="vertical-align:middle;"></i>
        <span class="fw-bold">{{ board.views }}</span> 조회
      </span>
      {% if board.tags and board.tags.length %}
      <span class="ms-3">
        {% for tag in board.tags %}
          <span class="badge bg-secondary">#{{ tag }}</span>
        {% endfor %}
      </span>
      {% endif %}
    </div>
    {% if board.attachments and board.attachments.length %}
<div class="mb-2">
  <span class="fw-bold">첨부파일:</span>
  <ul class="list-unstyled d-inline-block align-middle mb-0" id="attachmentList">
    {% for file in board.attachments %}
      <li class="d-flex align-items-center mb-1" data-id="{{ file._id }}" data-type="{{ file.mimetype }}">
        <a href="{{ file.url }}" class="me-2 file-download-link" download>{{ file.originalname }}</a>
        {% if session.userId == board.author._id or session.role == 'admin' %}
          <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-1 file-delete-btn" data-id="{{ file._id }}">X</button>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  <div class="d-inline-block ms-2">
    <button type="button" class="btn btn-outline-info btn-sm me-1" id="downloadAllBtn">한번에 내려받기</button>
    {% if session.userId == board.author._id or session.role == 'admin' %}
      <button type="button" class="btn btn-outline-danger btn-sm" id="deleteAllBtn">모두삭제</button>
    {% endif %}
  </div>
</div>
{% endif %}
    <h6 class="card-subtitle mb-2 text-muted">{{ board.author.name or board.author.username }} | {{ board.createdAt|date('Y-m-d') }}</h6>
    <p class="card-text">{{ board.content }}</p>
    {% if board.attachments and board.attachments.length %}
  <div id="imagePreviewArea" class="mb-3">
    {% for file in board.attachments %}
      {% if file.mimetype and file.mimetype.startswith('image/') %}
        <img src="{{ file.url }}" alt="{{ file.originalname }}" class="img-fluid mb-2 d-block attachment-image" data-id="{{ file._id }}" style="max-width:300px;"/>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}
    <div class="mb-3">
      <button id="likeBtn" class="btn btn-outline-primary btn-sm" type="button" {% if not session.userId %}disabled{% endif %}>
        <i class="lucide lucide-thumbs-up" style="vertical-align:middle;"></i>
        <span id="likeBtnText">{% if liked %}추천 취소{% else %}추천{% endif %}</span>
        <span id="likeCount" class="ms-1">{{ board.likes }}</span>
      </button>
    </div>
    {% if session.userId == board.author._id or session.role == 'admin' %}
    <a href="/board/edit?id={{ board._id }}" class="btn btn-warning">수정</a>
    <button id="deleteBtn" class="btn btn-danger ms-2" type="button">삭제</button>
    {% endif %}
    <a href="/board" class="btn btn-secondary">목록</a>
  </div>
</div>
<!-- 댓글/대댓글 영역 -->
<div class="mt-5">
  <h5>댓글</h5>
  <!-- 댓글 입력 폼 -->
  <form id="commentForm" class="mb-3">
    <input type="hidden" name="parent" id="commentParentId">
    <div class="mb-2">
      <textarea class="form-control" name="content" id="commentContent" rows="2" placeholder="댓글을 입력하세요" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary btn-sm">댓글 등록</button>
    <button type="button" class="btn btn-secondary btn-sm d-none" id="cancelReplyBtn">취소</button>
  </form>
  <!-- 댓글 목록 -->
  <div id="comments">
    {% for comment in comments %}
      <div class="mb-2" style="margin-left:{{ comment.depth * 32 }}px;">
        <div class="d-flex align-items-center">
          <span class="fw-bold me-2">{{ comment.authorName }}</span>
          <span class="text-muted small me-2">{{ comment.createdAt|date('Y-m-d H:i') }}</span>
          {% if session.userId == comment.authorId or session.role == 'admin' %}
            <button class="btn btn-link btn-sm p-0 me-1 edit-comment-btn" data-id="{{ comment._id }}">수정</button>
            <button class="btn btn-link btn-sm p-0 text-danger delete-comment-btn" data-id="{{ comment._id }}">삭제</button>
          {% endif %}
          <button class="btn btn-link btn-sm p-0 reply-comment-btn" data-id="{{ comment._id }}">답글</button>
        </div>
        <div class="comment-content" id="comment-content-{{ comment._id }}">{{ comment.content }}</div>
      </div>
    {% else %}
      <div class="text-muted">댓글이 없습니다.</div>
    {% endfor %}
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>lucide.createIcons();</script>
<script>
  document.getElementById('likeBtn')?.addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    const res = await fetch('/board/like', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: '{{ board._id }}' })
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('likeCount').textContent = data.likes;
      document.getElementById('likeBtnText').textContent = data.liked ? '추천 취소' : '추천';
      btn.classList.toggle('btn-primary', data.liked);
      btn.classList.toggle('btn-outline-primary', !data.liked);
    } else {
      alert(data.message || '오류');
    }
    btn.disabled = false;
  });
  document.getElementById('deleteBtn')?.addEventListener('click', async function() {
    if (!confirm('정말 삭제하시겠습니까?')) return;
    const res = await fetch('/board/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: '{{ board._id }}' })
    });
    const data = await res.json();
    if (data.success) {
      alert('삭제되었습니다.');
      location.href = '/board';
    } else {
      alert(data.message || '삭제 실패');
    }
  });
// 댓글/대댓글 입력, 수정, 삭제, 답글 UI 처리 (AJAX)
let replyParentId = null;
document.querySelectorAll('.reply-comment-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    replyParentId = this.dataset.id;
    document.getElementById('commentParentId').value = replyParentId;
    document.getElementById('commentContent').focus();
    document.getElementById('cancelReplyBtn').classList.remove('d-none');
  });
});
document.getElementById('cancelReplyBtn')?.addEventListener('click', function() {
  replyParentId = null;
  document.getElementById('commentParentId').value = '';
  this.classList.add('d-none');
});
document.getElementById('commentForm')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  const content = document.getElementById('commentContent').value.trim();
  const parent = document.getElementById('commentParentId').value;
  if (!content) return;
  const res = await fetch('/comment/write', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ board: '{{ board._id }}', content, parent })
  });
  const data = await res.json();
  if (data.success) location.reload();
  else alert(data.message || '댓글 등록 실패');
});
document.querySelectorAll('.delete-comment-btn').forEach(btn => {
  btn.addEventListener('click', async function() {
    if (!confirm('댓글을 삭제하시겠습니까?')) return;
    const res = await fetch('/comment/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: this.dataset.id })
    });
    const data = await res.json();
    if (data.success) location.reload();
    else alert(data.message || '삭제 실패');
  });
});

// 첨부파일 삭제/다운로드
function removeAttachmentFromUI(fileId) {
  // 목록에서 제거
  const li = document.querySelector(`#attachmentList li[data-id='${fileId}']`);
  if (li) li.remove();
  // 이미지 미리보기 제거
  const img = document.querySelector(`#imagePreviewArea img[data-id='${fileId}']`);
  if (img) img.remove();
}

document.querySelectorAll('.file-delete-btn').forEach(btn => {
  btn.addEventListener('click', async function() {
    if (!confirm('첨부파일을 삭제하시겠습니까?')) return;
    const fileId = this.dataset.id;
    const res = await fetch('/attachment/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: fileId })
    });
    const data = await res.json();
    if (data.success) {
      removeAttachmentFromUI(fileId);
    } else {
      alert(data.message || '삭제 실패');
    }
  });
});

document.getElementById('deleteAllBtn')?.addEventListener('click', async function() {
  if (!confirm('첨부파일을 모두 삭제하시겠습니까?')) return;
  const res = await fetch('/attachment/deleteAll', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ boardId: '{{ board._id }}' })
  });
  const data = await res.json();
  if (data.success) {
    // 목록, 이미지 모두 제거
    document.getElementById('attachmentList').innerHTML = '';
    document.getElementById('imagePreviewArea').innerHTML = '';
  } else {
    alert(data.message || '삭제 실패');
  }
});

document.getElementById('downloadAllBtn')?.addEventListener('click', function() {
  window.location.href = '/attachment/downloadAll?boardId={{ board._id }}';
});
</script>
{% endblock %} 